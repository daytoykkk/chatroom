<!DOCTYPE html>
<html lang="en">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap-theme.min.css"
      integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
<head>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<div class="row">
    <div class="col-md-2">
        <div class="list-group" id="roomlist">

        </div>

    </div>


    <div class="col-md-10">
        <ul class="MessageList">


        </ul>

        <div id="chatSend">
            <div id="fasong"><textarea cols="140" rows="4" placeholder="Type your message..." id="msg_text"></textarea>
            </div>
            <div>
                <form action="http://39.106.119.191/api/msg/picture/?token=5687eda998f64948a5c0d1b12986cd70&roomid=1"
                      class="form-horizontal" method="post" enctype="multipart/form-data">
                    <input class="style_file_content" accept="image/gif, image/jpeg, image/jpg,image/jpg" type="file"
                           name="picture"/>
                    <button type="submit" class="btn btn-default">上传图片</button>
                </form>
                <div id="senda">
                    <center><a href="#" onclick="send_message()"><span class="fa fa-send-o"></span></a></center>
                </div>

            </div>
        </div>

    </div>


    <script src="https://code.jquery.com/jquery.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous"></script>
    <script>

        $(document).ready(function () {
                //进入页面的获取用户的房间列表
                var token = "5687eda998f64948a5c0d1b12986cd70";
                var userid = 2;
                $.ajax({
                    url: "http://39.106.119.191/api/room/",
                    type: 'GET',
                    data: "token=" + token,
                    dataType: 'json',
                    success: function (res) {
                        if (res.status == 200) {
                            for (var i = 0; i < res.data.length; i++) {
                                var room = res.data[i];
                                //加载房间列表
                                $("#roomlist").append("<a class=\"list-group-item \" href='#' id=" + room.id + ">" + "<img class=\"img-circle\" data-src=\"holder.js/64x64\" " +
                                    "alt=\"64x64\" src=\"http://39.106.119.191/uploads/rooms/" + room.icon + "\"" +
                                    "data-holder-rendered=\"true\" style=\"width: 44px; height: 44px;\">" + room.name + "<span class=\"online_num\">(1)</span><span class=\"badge\" style='text-align: right'>0</span>" + "<br><small>" + room.detail + "</small>" + "</a>");
                                //连接所有房间的websocket
                            }
                            //默认第一个房间为 active 样式
                            $(".list-group-item").first().addClass('active');

                            //加载第一个房间的消息
                            $.ajax({
                                url: "http://39.106.119.191/api/msg/",
                                type: 'GET',
                                data: "token=" + token + "&roomid=" + res.data[0].id,
                                dataType: 'json',
                                success: function (res) {
                                    if (res.status == 200) {
                                        for (var i = 0; i < res.data.length; i++) {
                                            var message = res.data[i];
                                            //加载第一个房间的消息
                                            if (message.type == 1) {
                                                if (message.user_id != userid) {
                                                    $(".MessageList").append("<div class=\"media\">\n" +
                                                        "                <div class=\"media-left media-middle\">\n" +
                                                        "                    <a href=\"#\">\n" +
                                                        "                        <img class=\"img-circle\" data-src=\"holder.js/64x64\" alt=\"64x64\"\n" +
                                                        "                              src=\"http://39.106.119.191/uploads/usericons/" + message.user_icon + "\"\n" +
                                                        "                             data-holder-rendered=\"true\" style=\"width: 64px; height: 64px;\">\n" +
                                                        "                    </a>\n" +
                                                        "                </div>\n" +
                                                        "                <div class=\"media-body\">\n" +
                                                        "\n" +
                                                        "                    <h5  class=\"media-heading\">\n" +
                                                        "                        <time title=\"2020-03-07 14:35:12\" datetime=\"2020-03-07 14:35:12\">" + message.time + "<br>" + message.from_user +
                                                        "                        </time>\n" +
                                                        "                    </h5>\n" +
                                                        "                    " + "<h4>" + message.msg + "</h4>" + "\n" +
                                                        "                </div>\n" +
                                                        "            </div>")
                                                } else {
                                                    $(".MessageList").append("<div class=\"media\">\n" +
                                                        "                <div class=\"media-body\">\n" +
                                                        "                    <h4 class=\"media-heading\">\n" +
                                                        "                        <time title=\"2020-03-07 14:35:12\" datetime=\"2020-03-07 14:35:12\">" + message.time + "\n" +
                                                        "                        </time>\n" +
                                                        "                    </h4>\n" +
                                                        message.msg +
                                                        "                </div>\n" +
                                                        "                <div class=\"media-right\">\n" +
                                                        "                    <a href=\"#\">\n" +
                                                        "                        <img class=\"img-circle\" data-src=\"holder.js/64x64\" alt=\"64x64\"\n" +
                                                        "                              src=\"http://39.106.119.191/uploads/usericons/" + message.user_icon + "\"\n" +
                                                        "                             data-holder-rendered=\"true\" style=\"width: 64px; height: 64px;\">\n" +
                                                        "                    </a>\n" +
                                                        "                </div>\n" +
                                                        "            </div>\n")
                                                }
                                            } else if (message.type == 2) {
                                                console.log(message);
                                                if (message.user_id != userid) {
                                                    $(".MessageList").append("<div class=\"media\">\n" +
                                                        "                <div class=\"media-left media-middle\">\n" +
                                                        "                    <a href=\"#\">\n" +
                                                        "                        <img class=\"img-circle\" data-src=\"holder.js/64x64\" alt=\"64x64\"\n" +
                                                        "                              src=\"http://39.106.119.191/uploads/usericons/" + message.user_icon + "\"\n" +
                                                        "                             data-holder-rendered=\"true\" style=\"width: 64px; height: 64px;\">\n" +
                                                        "                    </a>\n" +
                                                        "                </div>\n" +
                                                        "                <div class=\"media-body\">\n" +
                                                        "\n" +
                                                        "                    <h5  class=\"media-heading\">\n" +
                                                        "                        <time title=\"2020-03-07 14:35:12\" datetime=\"2020-03-07 14:35:12\">" + message.time + "<br>" + message.from_user +
                                                        "                        </time>\n" +
                                                        "                    </h5>\n" +
                                                        "                    " + "<img style=\"height: 250px\" data-src=\"holder.js/64x64\" alt=\"64x64\" src=\"" + message.msg + "\" data-holder-rendered=\"true\" >" + "\n" +
                                                        "                </div>\n" +
                                                        "            </div>")
                                                } else {
                                                    $(".MessageList").append("<div class=\"media\">\n" +
                                                        "                <div class=\"media-body\">\n" +
                                                        "                    <h4 class=\"media-heading\">\n" +
                                                        "                        <time title=\"2020-03-07 14:35:12\" datetime=\"2020-03-07 14:35:12\">" + message.time + "\n" +
                                                        "                        </time>\n" +
                                                        "                    </h4>\n" +
                                                        "                    " + "<img style=\"height: 250px\" data-src=\"holder.js/64x64\" alt=\"64x64\" src=\"" + message.msg + "\" data-holder-rendered=\"true\" >" + "\n" +
                                                        "                </div>\n" +
                                                        "                <div class=\"media-right\">\n" +
                                                        "                    <a href=\"#\">\n" +
                                                        "                        <img class=\"img-circle\" data-src=\"holder.js/64x64\" alt=\"64x64\"\n" +
                                                        "                              src=\"http://39.106.119.191/uploads/usericons/" + message.user_icon + "\"\n" +
                                                        "                             data-holder-rendered=\"true\" style=\"width: 64px; height: 64px;\">\n" +
                                                        "                    </a>\n" +
                                                        "                </div>\n" +
                                                        "            </div>\n")
                                                }
                                            } else {
                                                let msg_num = $("#" + message.roomid).children(".badge").text();
                                                $("#" + message.roomid).children(".badge").text(Number(msg_num) + 1);
                                            }

                                        }
                                    }
                                }
                            });


                            //点击聊天室时active 样式的变化 和消息的加载
                            $('.list-group-item').click(function (e) {
                                    e.preventDefault();
                                    $('.list-group-item').removeClass('active');
                                    $(this).addClass('active');
                                    $(this).children(".badge").text(0);
                                    //删除原来的消息
                                    $(".MessageList").empty();
                                    $.ajax({
                                        url: "http://39.106.119.191/api/msg/",
                                        type: 'GET',
                                        data: "token=" + token + "&roomid=" + $(this).attr("id"),
                                        dataType: 'json',
                                        success: function (res) {
                                            if (res.status == 200) {
                                                for (var i = 0; i < res.data.length; i++) {
                                                    var message = res.data[i];
                                                    //加载消息
                                                    if (message.type == 1) {
                                                        if (message.user_id != userid) {
                                                            $(".MessageList").append("<div class=\"media\">\n" +
                                                                "                <div class=\"media-left media-middle\">\n" +
                                                                "                    <a href=\"#\">\n" +
                                                                "                        <img class=\"img-circle\" data-src=\"holder.js/64x64\" alt=\"64x64\"\n" +
                                                                "                              src=\"http://39.106.119.191/uploads/usericons/" + message.user_icon + "\"\n" +
                                                                "                             data-holder-rendered=\"true\" style=\"width: 64px; height: 64px;\">\n" +
                                                                "                    </a>\n" +
                                                                "                </div>\n" +
                                                                "                <div class=\"media-body\">\n" +
                                                                "\n" +
                                                                "                    <h5  class=\"media-heading\">\n" +
                                                                "                        <time title=\"2020-03-07 14:35:12\" datetime=\"2020-03-07 14:35:12\">" + message.time + "<br>" + message.from_user +
                                                                "                        </time>\n" +
                                                                "                    </h5>\n" +
                                                                "                    " + "<h4>" + message.msg + "</h4>" + "\n" +
                                                                "                </div>\n" +
                                                                "            </div>")
                                                        } else {
                                                            $(".MessageList").append("<div class=\"media\">\n" +
                                                                "                <div class=\"media-body\">\n" +
                                                                "                    <h4 class=\"media-heading\">\n" +
                                                                "                        <time title=\"2020-03-07 14:35:12\" datetime=\"2020-03-07 14:35:12\">" + message.time + "\n" +
                                                                "                        </time>\n" +
                                                                "                    </h4>\n" +
                                                                message.msg +
                                                                "                </div>\n" +
                                                                "                <div class=\"media-right\">\n" +
                                                                "                    <a href=\"#\">\n" +
                                                                "                        <img class=\"img-circle\" data-src=\"holder.js/64x64\" alt=\"64x64\"\n" +
                                                                "                              src=\"http://39.106.119.191/uploads/usericons/" + message.user_icon + "\"\n" +
                                                                "                             data-holder-rendered=\"true\" style=\"width: 64px; height: 64px;\">\n" +
                                                                "                    </a>\n" +
                                                                "                </div>\n" +
                                                                "            </div>\n")
                                                        }
                                                    } else if (message.type == 2) {
                                                        if (message.user_id != userid) {
                                                            $(".MessageList").append("<div class=\"media\">\n" +
                                                                "                <div class=\"media-left media-middle\">\n" +
                                                                "                    <a href=\"#\">\n" +
                                                                "                        <img class=\"img-circle\" data-src=\"holder.js/64x64\" alt=\"64x64\"\n" +
                                                                "                              src=\"http://39.106.119.191/uploads/usericons/" + message.user_icon + "\"\n" +
                                                                "                             data-holder-rendered=\"true\" style=\"width: 64px; height: 64px;\">\n" +
                                                                "                    </a>\n" +
                                                                "                </div>\n" +
                                                                "                <div class=\"media-body\">\n" +
                                                                "\n" +
                                                                "                    <h5  class=\"media-heading\">\n" +
                                                                "                        <time title=\"2020-03-07 14:35:12\" datetime=\"2020-03-07 14:35:12\">" + message.time + "<br>" + message.from_user +
                                                                "                        </time>\n" +
                                                                "                    </h5>\n" +
                                                                "                    " + "<img style=\"height: 250px\" data-src=\"holder.js/64x64\" alt=\"64x64\" src=\"" + message.msg + "\" data-holder-rendered=\"true\" >" + "\n" +
                                                                "                </div>\n" +
                                                                "            </div>")
                                                        } else {
                                                            $(".MessageList").append("<div class=\"media\">\n" +
                                                                "                <div class=\"media-body\">\n" +
                                                                "                    <h4 class=\"media-heading\">\n" +
                                                                "                        <time title=\"2020-03-07 14:35:12\" datetime=\"2020-03-07 14:35:12\">" + message.time + "\n" +
                                                                "                        </time>\n" +
                                                                "                    </h4>\n" +
                                                                "                    " + "<img style=\"height: 250px\" data-src=\"holder.js/64x64\" alt=\"64x64\" src=\"" + message.msg + "\" data-holder-rendered=\"true\" >" + "\n" +
                                                                "                </div>\n" +
                                                                "                <div class=\"media-heading\">\n" +
                                                                "                    <a href=\"#\">\n" +
                                                                "                        <img class=\"img-circle\" data-src=\"holder.js/64x64\" alt=\"64x64\"\n" +
                                                                "                              src=\"http://39.106.119.191/uploads/usericons/" + message.user_icon + "\"\n" +
                                                                "                             data-holder-rendered=\"true\" style=\"width: 64px; height: 64px;\">\n" +
                                                                "                    </a>\n" +
                                                                "                </div>\n" +
                                                                "            </div>\n")
                                                        }
                                                    } else {
                                                        let msg_num = $("#" + message.roomid).children(".badge").text();
                                                        $("#" + message.roomid).children(".badge").text(Number(msg_num) + 1);
                                                    }

                                                }
                                            }
                                        }
                                    });

                                }
                            );

                        }
                    }
                })
            }
        )
        ;

    </script>

    <script type="text/javascript">
        var token = "5687eda998f64948a5c0d1b12986cd70";
        var userid = 2;
        //websocket部分
        let None = "";
        var ws = null;

        ws = new WebSocket("ws://39.106.119.191/api/ws/" + "?token=" + token);

        function send_message() {
            //获取当前的房间id
            var roomid = $(".list-group-item.active").attr('id');
            var msg = $("#msg_text").val();

            send_msg = {
                "msg": msg,
                "type": 1,
                "roomid": roomid,
            };
            ws.send(JSON.stringify(send_msg));
        }

        ws.onclose = function (e) {
            console.log('websocket 断开: ' + e.code + ' ' + e.reason + ' ' + e.wasClean);
            console.log(e);
            window.location.reload();
        }

        //主动关闭
        window.onbeforeunload = function (event) {

            alert("您确定离开该网页吗？");
            console.log("关闭WebSocket连接！");
            send_msg = {
                "msg": msg,
                "type": 0,
                "is_online": 0,
            };
            ws.send(JSON.stringify(send_msg));

        }

        //接收信息
        ws.onmessage = function (data) {

            var message = eval('(' + data.data + ')');
            var roomid = $(".list-group-item.active").attr('id');
            if (message.type == 1) {
                if ($(".list-group-item.active").attr('id') == message.roomid) {
                    if (message.user_id != userid) {
                        $(".MessageList").append("<div class=\"media\">\n" +
                            "                <div class=\"media-left media-middle\">\n" +
                            "                    <a href=\"#\">\n" +
                            "                        <img class=\"img-circle\" data-src=\"holder.js/64x64\" alt=\"64x64\"\n" +
                            "                              src=\"http://39.106.119.191/uploads/usericons/" + message.user_icon + "\"\n" +
                            "                             data-holder-rendered=\"true\" style=\"width: 64px; height: 64px;\">\n" +
                            "                    </a>\n" +
                            "                </div>\n" +
                            "                <div class=\"media-body\">\n" +
                            "\n" +
                            "                    <h5  class=\"media-heading\">\n" +
                            "                        <time title=\"2020-03-07 14:35:12\" datetime=\"2020-03-07 14:35:12\">" + message.time + "<br>" + message.from_user +
                            "                        </time>\n" +
                            "                    </h5>\n" +
                            "                    " + "<h4>" + message.msg + "</h4>" + "\n" +
                            "                </div>\n" +
                            "            </div>")
                    } else {
                        $(".MessageList").append("<div class=\"media\">\n" +
                            "                <div class=\"media-body\">\n" +
                            "                    <h4 class=\"media-heading\">\n" +
                            "                        <time title=\"2020-03-07 14:35:12\" datetime=\"2020-03-07 14:35:12\">" + message.time + "\n" +
                            "                        </time>\n" +
                            "                    </h4>\n" +
                            message.msg +
                            "                </div>\n" +
                            "                <div class=\"media-right\">\n" +
                            "                    <a href=\"#\">\n" +
                            "                        <img class=\"img-circle\" data-src=\"holder.js/64x64\" alt=\"64x64\"\n" +
                            "                              src=\"http://39.106.119.191/uploads/usericons/" + message.user_icon + "\"\n" +
                            "                             data-holder-rendered=\"true\" style=\"width: 64px; height: 64px;\">\n" +
                            "                    </a>\n" +
                            "                </div>\n" +
                            "            </div>\n")
                    }
                } else {
                    let msg_num = $("#" + message.roomid).children(".badge").text();
                    $("#" + message.roomid).children(".badge").text(Number(msg_num) + 1);
                }
            } else if (message.type == 0) {
                $(function () {
                    $(".list-group-item").each(function () {
                        roomid = $(this).attr('id');
                        if (roomid == message.roomid) {
                            $(this).children(".online_num").text("(" + message.num + ")");
                        }
                    })

                });

                if (message.roomid == roomid) {
                    if (message.is_online == 1) {
                        $(".MessageList").append("<div class=\"well well-sm\">" + message.username + "上线了 总人数:" + message.num + "</div>")
                    } else {
                        console.log(message);
                        $(".MessageList").append("<div class=\"well well-sm\">" + message.username + "下线了 总人数:" + message.num + "</div>")
                    }
                }
            } else if (message.type == 2) {
                if (message.user_id != userid) {
                    $(".MessageList").append("<div class=\"media\">\n" +
                        "                <div class=\"media-left media-middle\">\n" +
                        "                    <a href=\"#\">\n" +
                        "                        <img class=\"img-circle\" data-src=\"holder.js/64x64\" alt=\"64x64\"\n" +
                        "                              src=\"http://39.106.119.191/uploads/usericons/" + message.user_icon + "\"\n" +
                        "                             data-holder-rendered=\"true\" style=\"width: 64px; height: 64px;\">\n" +
                        "                    </a>\n" +
                        "                </div>\n" +
                        "                <div class=\"media-body\">\n" +
                        "\n" +
                        "                    <h5  class=\"media-heading\">\n" +
                        "                        <time title=\"2020-03-07 14:35:12\" datetime=\"2020-03-07 14:35:12\">" + message.time + "<br>" + message.from_user +
                        "                        </time>\n" +
                        "                    </h5>\n" +
                        "                    " + "<img style=\"height: 250px\" data-src=\"holder.js/64x64\" alt=\"64x64\" src=\"" + message.msg + "\" data-holder-rendered=\"true\" >" + "\n" +
                        "                </div>\n" +
                        "            </div>")
                } else {
                    $(".MessageList").append("<div class=\"media\">\n" +
                        "                <div class=\"media-body\">\n" +
                        "                    <h4 class=\"media-heading\">\n" +
                        "                        <time title=\"2020-03-07 14:35:12\" datetime=\"2020-03-07 14:35:12\">" + message.time + "\n" +
                        "                        </time>\n" +
                        "                    </h4>\n" +
                        "                    " + "<img style=\"height: 250px\" data-src=\"holder.js/64x64\" alt=\"64x64\" src=\"" + message.msg + "\" data-holder-rendered=\"true\" >" + "\n" +
                        "                </div>\n" +
                        "                <div class=\"media-right\">\n" +
                        "                    <a href=\"#\">\n" +
                        "                        <img class=\"img-circle\" data-src=\"holder.js/64x64\" alt=\"64x64\"\n" +
                        "                              src=\"http://39.106.119.191/uploads/usericons/" + message.user_icon + "\"\n" +
                        "                             data-holder-rendered=\"true\" style=\"width: 64px; height: 64px;\">\n" +
                        "                    </a>\n" +
                        "                </div>\n" +
                        "            </div>\n")
                }
            } else {
                let msg_num = $("#" + message.roomid).children(".badge").text();
                $("#" + message.roomid).children(".badge").text(Number(msg_num) + 1);
            }
        }

    </script>
</body>
</html>